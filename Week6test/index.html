<!DOCTYPE html>
<html>
	<head>
		<link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
		<script src="/socket.io/socket.io.js"></script>
		<script type="text/javascript">
			var socket = io.connect();
			var clientID;
			var video;
			var clientList;
			var dataUrl;
			var thecanvas;
			// when this client connects, assign their socket.id to clientID
			socket.on('connect', function() {
				console.log("Connected");
				clientID = socket.io.engine.id;
				console.log("My client id: " + clientID);
			});
			// check to see if our client is already connected
			// if not, add divs with IDs unique for each client
			// as passed in as "data" in the callback
  			socket.on('client', function (data){
  				//create a div only if is a new user
  				for (var i=0; i < data.length; i++){
  					if (document.getElementById(data[i])==null){
  					console.log("userlist "+ data[i]);
  					// add new div with id, picture and message of each connected user
  					//we repeat document.getElementById because it would replace the same before
  					document.getElementById('box').innerHTML = document.getElementById('box').innerHTML+'<div id="'+data[i]+'" style="float:left; border-width:2px; border-style: solid; border-color: transparent;"> <img id="img'+data[i]+'" src=""><div id="text'+data[i]+'"></div> </div>';
  					}
  				}
  			});
  			//remove disconnected users
  			// 'userdisconnected' is called inside socket.on('disconnect', ...) -- see server.js
  			// server emits socket.id and is passed to the callback below as "data"
  			socket.on('userdisconnected', function(data){
  				// remove all children that are ID'd by the socket.id coming in as "data"
  				document.getElementById('box').removeChild(document.getElementById(data));
  			});
  			// define media sources for the divs created in socket.on('client', ...)
  			//there are empty src left to be able to push new data
  			socket.on('allinfo', function(data){
  				document.getElementById('img'+data.id).src=data.image;
  				document.getElementById('text'+data.id).innerHTML=data.text;

  			});
			function init(){
				//get video streaming from each user and play it only on their browser
				window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
				navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
				video=document.getElementById("thevideo");
				//video is constantly running, but it's hidden, so we don't see it
				if (navigator.getUserMedia) {
					navigator.getUserMedia({video: true}, function(stream) {
						video.src = window.URL.createObjectURL(stream) || stream;
						video.play();
						}, function(error) {alert("Failure " + error.code);}
					);
				}
				// console.log('video is not null');
				thecanvas = document.getElementById("thecanvas");
				var thecontext = thecanvas.getContext('2d');
				var draw = function() {
					//draw the video on the canvas
					thecontext.drawImage(video,0,0,video.width,video.height);
					setTimeout(draw,500);	
				};
				draw();	
			}
			window.addEventListener('load',init);
			// on submission, capture current frame into dataUrl
			// and emit that and the text in id='message' to the
			// server as an object
			function submitClicked(){
				//info about the image on the canvas
				//canvas is always listening to the video, this says take the snapshot of the video
				dataUrl = thecanvas.toDataURL('image/webp', 1);
				var newMessage = document.getElementById("message").value;
				console.log("clicked")
				//going from this client to the server
				socket.emit('allinfo',{
					image:dataUrl, 
					text:newMessage});

			}
			function enter(evt) {
		        if (evt && evt.keyCode == 13) {
		            submitClicked();
		        }
		    }
		</script>
	</head>
	<body>
		<link rel="stylesheet" type="text/css" href="style.css">
<br/>
		<div id="box">
			<input id='message' name='message' type='text' class='textarea' onKeyPress='return enter(event)'>
			<input id='submit-message' type='submit' class='submitbutton' value='Send Message' onclick='submitClicked()'>		
			<br/>
			<br/>
		</div>
		<video id="thevideo" width="310" height="240"></video>
		<canvas id="thecanvas" width="310" height="240"></canvas>
	</body>
</html>